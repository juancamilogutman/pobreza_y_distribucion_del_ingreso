---
title: "Simulación pobreza y distribución del ingreso"
format:
  html:
    embed-resources: true
    theme: cosmo
    toc: true
    toc-depth: 2
    css: |
      .quarto-container {
        max-width: 95% !important;
        margin-left: auto !important;
        margin-right: auto !important;
      }
      body {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }
---

## Introducción

Simulación interactiva que muestra cómo cambia la pobreza bajo dos escenarios:

1. Aumento el ingreso promedio manteniendo la dispersión constante
2. Cambia la dispersión del ingreso manteniendo el ingreso promedio similar

**Líneas de referencia en los gráficos:**

- <span style="color: red;">**━━━ Línea de pobreza**</span> (roja, discontinua): $15.000
- <span style="color: #ff7f0e;">**⋯⋯ Mediana**</span> (naranja, punteada)
- <span style="color: #1f77b4;">**━━━ Media**</span> (azul, sólida)

La diferencia entre media y mediana muestra la **asimetría de la distribución**: en distribuciones desiguales, la media es mayor que la mediana porque los ingresos altos tiran el promedio hacia arriba.

```{r setup, echo=FALSE, include=FALSE}
library(plotly)
library(dplyr)
library(purrr)
library(scales)

set.seed(123)
N <- 100000  # Increased for smoother distribution
linea_de_pobreza <- 15000

# Bins de a 1000 y línea de pobreza 15.000 logran que la línea siempre corte entre barras.
bins_config <- list(start = 0, end = 80000, size = 1000)

# Función para calcular el coeficiente de Gini
calc_gini <- function(x) {
  x <- sort(x[x >= 0])
  n <- length(x)
  gini <- 2 * sum((1:n) * x) / (n * sum(x)) - (n + 1) / n
  return(gini)
}
```

## Caso 1:

**Dispersión constante**, se mueve toda la distribución hacia arriba (aumenta el ingreso promedio).

```{r}
#| label: prom_plot
#| echo: false
#| message: false
#| warning: false

# sdlog fijo = dispersión constante, variamos meanlog
fixed_sdlog <- 0.6
meanlog_vals <- seq(9.8, 10.4, by = 0.15)
initial_mean_idx <- 3

mean_steps_data <- tibble(meanlog = meanlog_vals) %>%
  mutate(
    label = paste0("$", format(round(exp(meanlog + fixed_sdlog^2/2)), big.mark = ".")),
    income_sample = map(meanlog, ~rlnorm(N, .x, fixed_sdlog)),
    poverty_count = map_dbl(income_sample, ~sum(.x < linea_de_pobreza)),
    poverty_pct = poverty_count / N,
    gini = map_dbl(income_sample, calc_gini),
    actual_mean = map_dbl(income_sample, mean),
    median_income = map_dbl(income_sample, median)
  )

# Initial values
initial_sample <- mean_steps_data$income_sample[[initial_mean_idx]]
initial_poverty_sample <- initial_sample[initial_sample < linea_de_pobreza]
initial_non_poverty_sample <- initial_sample[initial_sample >= linea_de_pobreza]

# Create metrics text for annotation
create_metrics_text <- function(idx) {
  paste0(
    "<b style='font-size:15px'>Indicadores</b><br>",
    "─────────────────<br>",
    "<b>Coef. Gini:</b> ", round(mean_steps_data$gini[[idx]], 3), "<br>",
    "<b>Ingreso promedio:</b> $", format(round(mean_steps_data$actual_mean[[idx]]), big.mark = "."), "<br>",
    "<b>% en pobreza:</b> ", percent(mean_steps_data$poverty_pct[[idx]], accuracy = 0.1)
  )
}

# Create histogram with metrics box
p_mean <- plot_ly(alpha = 0.8) %>%
  add_histogram(
    x = initial_poverty_sample,
    name = "En pobreza",
    xbins = bins_config,
    marker = list(color = '#d62728')
  ) %>%
  add_histogram(
    x = initial_non_poverty_sample,
    name = "Sobre línea de pobreza",
    xbins = bins_config,
    marker = list(color = '#2ca02c')
  ) %>%
  layout(
    title = "",
    barmode = 'stack',
    xaxis = list(range = c(0, 80000), title = "Ingreso mensual ($)", zeroline = FALSE),
    yaxis = list(title = "Cantidad de personas"),
    shapes = list(
      list(
        type = 'line',
        x0 = linea_de_pobreza, x1 = linea_de_pobreza,
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = 'red', width = 3, dash = 'dash'),
        name = 'Línea de pobreza'
      ),
      list(
        type = 'line',
        x0 = median(initial_sample), x1 = median(initial_sample),
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = '#ff7f0e', width = 2, dash = 'dot'),
        name = 'Mediana'
      ),
      list(
        type = 'line',
        x0 = mean(initial_sample), x1 = mean(initial_sample),
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = '#1f77b4', width = 2),
        name = 'Media'
      )
    ),
    annotations = list(
      list(
        x = 0.98, y = 0.98,
        xref = 'paper', yref = 'paper',
        text = create_metrics_text(initial_mean_idx),
        showarrow = FALSE,
        xanchor = 'right',
        yanchor = 'top',
        font = list(size = 13),
        bgcolor = 'rgba(255, 255, 255, 0.95)',
        bordercolor = '#2c3e50',
        borderwidth = 2,
        borderpad = 10,
        align = 'left'
      )
    )
  )

# Create slider steps that update histogram, metrics, and mean/median lines
mean_slider_steps <- purrr::map(1:nrow(mean_steps_data), function(i) {
  poverty_sample <- mean_steps_data$income_sample[[i]][mean_steps_data$income_sample[[i]] < linea_de_pobreza]
  non_poverty_sample <- mean_steps_data$income_sample[[i]][mean_steps_data$income_sample[[i]] >= linea_de_pobreza]

  sample_mean <- mean_steps_data$actual_mean[[i]]
  sample_median <- mean_steps_data$median_income[[i]]

  list(
    method = 'update',
    args = list(
      list(
        x = list(poverty_sample, non_poverty_sample)
      ),
      list(
        annotations = list(
          list(
            x = 0.98, y = 0.98,
            xref = 'paper', yref = 'paper',
            text = create_metrics_text(i),
            showarrow = FALSE,
            xanchor = 'right',
            yanchor = 'top',
            font = list(size = 13),
            bgcolor = 'rgba(255, 255, 255, 0.95)',
            bordercolor = '#2c3e50',
            borderwidth = 2,
            borderpad = 10,
            align = 'left'
          )
        ),
        shapes = list(
          list(
            type = 'line',
            x0 = linea_de_pobreza, x1 = linea_de_pobreza,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = 'red', width = 3, dash = 'dash')
          ),
          list(
            type = 'line',
            x0 = sample_median, x1 = sample_median,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = '#ff7f0e', width = 2, dash = 'dot')
          ),
          list(
            type = 'line',
            x0 = sample_mean, x1 = sample_mean,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = '#1f77b4', width = 2)
          )
        )
      )
    ),
    label = mean_steps_data$label[i]
  )
})

p_mean <- p_mean %>% layout(
  sliders = list(
    list(
      active = initial_mean_idx - 1,
      currentvalue = list(prefix = "Ingreso promedio: "),
      steps = mean_slider_steps,
      pad = list(t = 60)
    )
  )
)

p_mean
```

## Caso 2: Redistribución (cambia la desigualdad)

**Ingreso promedio similar**, pero varía la dispersión/desigualdad (concentración del ingreso).

```{r}
#| label: sd_plot
#| echo: false
#| message: false
#| warning: false

# meanlog fijo, variamos sdlog = cambia dispersión/desigualdad
fixed_meanlog <- 10.05
sdlog_vals <- seq(0.3, 0.9, by = 0.15)
initial_sd_idx <- 3

sd_steps_data <- tibble(sdlog = sdlog_vals) %>%
  mutate(
    label = paste0("Gini ≈ ", round(0.2 + sdlog * 0.45, 2)), # Aproximación para etiqueta
    income_sample = map(sdlog, ~rlnorm(N, fixed_meanlog, .x)),
    poverty_count = map_dbl(income_sample, ~sum(.x < linea_de_pobreza)),
    poverty_pct = poverty_count / N,
    gini = map_dbl(income_sample, calc_gini),
    actual_mean = map_dbl(income_sample, mean),
    median_income = map_dbl(income_sample, median)
  )

# Initial values
initial_sample_sd <- sd_steps_data$income_sample[[initial_sd_idx]]
initial_poverty_sample_sd <- initial_sample_sd[initial_sample_sd < linea_de_pobreza]
initial_non_poverty_sample_sd <- initial_sample_sd[initial_sample_sd >= linea_de_pobreza]

# Create metrics text for annotation
create_metrics_text_sd <- function(idx) {
  paste0(
    "<b style='font-size:15px'>Indicadores</b><br>",
    "─────────────────<br>",
    "<b>Coef. Gini:</b> ", round(sd_steps_data$gini[[idx]], 3), "<br>",
    "<b>Ingreso promedio:</b> $", format(round(sd_steps_data$actual_mean[[idx]]), big.mark = "."), "<br>",
    "<b>% en pobreza:</b> ", percent(sd_steps_data$poverty_pct[[idx]], accuracy = 0.1)
  )
}

# Create histogram with metrics box
p_sd <- plot_ly(alpha = 0.8) %>%
  add_histogram(
    x = initial_poverty_sample_sd,
    name = "En pobreza",
    xbins = bins_config,
    marker = list(color = '#d62728')
  ) %>%
  add_histogram(
    x = initial_non_poverty_sample_sd,
    name = "Sobre línea de pobreza",
    xbins = bins_config,
    marker = list(color = '#2ca02c')
  ) %>%
  layout(
    title = "",
    barmode = 'stack',
    xaxis = list(range = c(0, 80000), title = "Ingreso mensual ($)", zeroline = FALSE),
    yaxis = list(title = "Cantidad de personas"),
    shapes = list(
      list(
        type = 'line',
        x0 = linea_de_pobreza, x1 = linea_de_pobreza,
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = 'red', width = 3, dash = 'dash'),
        name = 'Línea de pobreza'
      ),
      list(
        type = 'line',
        x0 = median(initial_sample_sd), x1 = median(initial_sample_sd),
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = '#ff7f0e', width = 2, dash = 'dot'),
        name = 'Mediana'
      ),
      list(
        type = 'line',
        x0 = mean(initial_sample_sd), x1 = mean(initial_sample_sd),
        y0 = 0, y1 = 1,
        yref = 'paper',
        line = list(color = '#1f77b4', width = 2),
        name = 'Media'
      )
    ),
    annotations = list(
      list(
        x = 0.98, y = 0.98,
        xref = 'paper', yref = 'paper',
        text = create_metrics_text_sd(initial_sd_idx),
        showarrow = FALSE,
        xanchor = 'right',
        yanchor = 'top',
        font = list(size = 13),
        bgcolor = 'rgba(255, 255, 255, 0.95)',
        bordercolor = '#2c3e50',
        borderwidth = 2,
        borderpad = 10,
        align = 'left'
      )
    )
  )

# Create slider steps that update histogram, metrics, and mean/median lines
sd_slider_steps <- purrr::map(1:nrow(sd_steps_data), function(i) {
  poverty_sample <- sd_steps_data$income_sample[[i]][sd_steps_data$income_sample[[i]] < linea_de_pobreza]
  non_poverty_sample <- sd_steps_data$income_sample[[i]][sd_steps_data$income_sample[[i]] >= linea_de_pobreza]

  sample_mean <- sd_steps_data$actual_mean[[i]]
  sample_median <- sd_steps_data$median_income[[i]]

  list(
    method = 'update',
    args = list(
      list(
        x = list(poverty_sample, non_poverty_sample)
      ),
      list(
        annotations = list(
          list(
            x = 0.98, y = 0.98,
            xref = 'paper', yref = 'paper',
            text = create_metrics_text_sd(i),
            showarrow = FALSE,
            xanchor = 'right',
            yanchor = 'top',
            font = list(size = 13),
            bgcolor = 'rgba(255, 255, 255, 0.95)',
            bordercolor = '#2c3e50',
            borderwidth = 2,
            borderpad = 10,
            align = 'left'
          )
        ),
        shapes = list(
          list(
            type = 'line',
            x0 = linea_de_pobreza, x1 = linea_de_pobreza,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = 'red', width = 3, dash = 'dash')
          ),
          list(
            type = 'line',
            x0 = sample_median, x1 = sample_median,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = '#ff7f0e', width = 2, dash = 'dot')
          ),
          list(
            type = 'line',
            x0 = sample_mean, x1 = sample_mean,
            y0 = 0, y1 = 1,
            yref = 'paper',
            line = list(color = '#1f77b4', width = 2)
          )
        )
      )
    ),
    label = sd_steps_data$label[i]
  )
})

p_sd <- p_sd %>% layout(
  sliders = list(
    list(
      active = initial_sd_idx - 1,
      currentvalue = list(prefix = "Dispersión (sdlog): "),
      steps = sd_slider_steps,
      pad = list(t = 60)
    )
  )
)

p_sd
```

## Notas metodológicas

- **Línea de pobreza**: Fijada en $15.000 para esta simulación (referencia ilustrativa).

- **Datos simulados**: N=100.000 personas. Los resultados son ilustrativos de los conceptos, no proyecciones reales.