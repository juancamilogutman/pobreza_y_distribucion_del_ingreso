---
title: "Simulación pobreza y distribución del ingreso"
format:
  html:
    embed-resources: true
    theme: cosmo
    toc: true
    toc-depth: 2
---

## Introducción

Simulación interactiva que muestra cómo cambia la pobreza bajo dos escenarios:

1. **Crecimiento económico**: Aumenta el ingreso promedio manteniendo la dispersión constante
2. **Redistribución**: Cambia la dispersión del ingreso manteniendo el ingreso promedio similar

La distribución utilizada es **Log-normal**, que refleja mejor la realidad de la desigualdad en Argentina: muchas personas con ingresos bajos y pocas con ingresos muy altos (asimetría positiva). Esta distribución tiene dos parámetros independientes:

- **meanlog**: Controla la ubicación (mueve toda la distribución)
- **sdlog**: Controla la dispersión/desigualdad (spread de la distribución)

```{r setup, echo=FALSE, include=FALSE}
library(plotly)
library(dplyr)
library(purrr)
library(scales)

set.seed(123)
N <- 10000
linea_de_pobreza <- 15000

# Bins de a 1000 y línea de pobreza 15.000 logran que la línea siempre corte entre barras.
bins_config <- list(start = 0, end = 80000, size = 1000)

# Función para calcular el coeficiente de Gini
calc_gini <- function(x) {
  x <- sort(x[x >= 0])
  n <- length(x)
  gini <- 2 * sum((1:n) * x) / (n * sum(x)) - (n + 1) / n
  return(gini)
}
```

## Caso 1: Crecimiento económico (aumenta ingreso promedio)

**Dispersión constante**, se mueve toda la distribución hacia arriba (aumenta el ingreso promedio).

```{r}
#| label: prom_plot
#| echo: false
#| message: false
#| warning: false

# sdlog fijo = dispersión constante, variamos meanlog
fixed_sdlog <- 0.6
meanlog_vals <- seq(9.8, 10.4, by = 0.15)
initial_mean_idx <- 3

mean_steps_data <- tibble(meanlog = meanlog_vals) %>%
  mutate(
    label = paste0("$", format(round(exp(meanlog + fixed_sdlog^2/2)), big.mark = ".")),
    income_sample = map(meanlog, ~rlnorm(N, .x, fixed_sdlog)),
    poverty_count = map_dbl(income_sample, ~sum(.x < linea_de_pobreza)),
    poverty_pct = poverty_count / N,
    gini = map_dbl(income_sample, calc_gini),
    actual_mean = map_dbl(income_sample, mean),
    median_income = map_dbl(income_sample, median),
    poverty_text = paste0(
      "<b>", percent(poverty_pct, accuracy = 0.1), "</b> en pobreza | ",
      "<b>Gini: ", round(gini, 3), "</b><br>",
      "Promedio: $", format(round(actual_mean), big.mark = "."),
      " | Mediana: $", format(round(median_income), big.mark = ".")
    )
  )

initial_sample <- mean_steps_data$income_sample[[initial_mean_idx]]
initial_poverty_sample <- initial_sample[initial_sample < linea_de_pobreza]
initial_non_poverty_sample <- initial_sample[initial_sample >= linea_de_pobreza]

p_mean <- plot_ly(alpha = 0.8) %>%
  add_histogram(
    x = initial_poverty_sample,
    name = "En pobreza",
    xbins = bins_config,
    marker = list(color = '#d62728')
  ) %>%
  add_histogram(
    x = initial_non_poverty_sample,
    name = "Sobre línea de pobreza",
    xbins = bins_config,
    marker = list(color = '#2ca02c')
  )

mean_slider_steps <- purrr::map(1:nrow(mean_steps_data), function(i) {
  poverty_sample <- mean_steps_data$income_sample[[i]][mean_steps_data$income_sample[[i]] < linea_de_pobreza]
  non_poverty_sample <- mean_steps_data$income_sample[[i]][mean_steps_data$income_sample[[i]] >= linea_de_pobreza]
  list(
    method = 'update',
    args = list(
      list(x = list(poverty_sample, non_poverty_sample)),
      list(annotations = list(list(text = mean_steps_data$poverty_text[[i]])))
    ),
    label = mean_steps_data$label[i]
  )
})

p_mean <- p_mean %>% layout(
  title = "Efecto del crecimiento económico sobre la pobreza<br><sub>Distribución Log-normal - Dispersión constante (sdlog=0.6)</sub>",
  xaxis = list(range = c(0, 80000), title = "Ingreso mensual ($)", zeroline = FALSE),
  yaxis = list(title = "Cantidad de personas"),
  barmode = 'stack',
  annotations = list(
    list(
      x = 0.98, y = 0.95,
      xref = 'paper', yref = 'paper',
      text = mean_steps_data$poverty_text[[initial_mean_idx]],
      showarrow = FALSE,
      xanchor = 'right',
      font = list(size = 13),
      bgcolor = 'rgba(255,255,255,0.8)',
      borderpad = 8
    )
  ),
  shapes = list(
    list(
      type = 'line',
      x0 = linea_de_pobreza, x1 = linea_de_pobreza,
      y0 = 0, y1 = 1,
      yref = 'paper',
      line = list(color = 'red', width = 2, dash = 'dash')
    )
  ),
  sliders = list(
    list(
      active = initial_mean_idx - 1,
      currentvalue = list(prefix = "Ingreso promedio: "),
      steps = mean_slider_steps,
      pad = list(t = 40)
    )
  )
)

p_mean
```

## Caso 2: Redistribución (cambia la desigualdad)

**Ingreso promedio similar**, pero varía la dispersión/desigualdad (concentración del ingreso).

```{r}
#| label: sd_plot
#| echo: false
#| message: false
#| warning: false

# meanlog fijo, variamos sdlog = cambia dispersión/desigualdad
fixed_meanlog <- 10.05
sdlog_vals <- seq(0.3, 0.9, by = 0.15)
initial_sd_idx <- 3

sd_steps_data <- tibble(sdlog = sdlog_vals) %>%
  mutate(
    label = paste0("Gini ≈ ", round(0.2 + sdlog * 0.45, 2)), # Aproximación para etiqueta
    income_sample = map(sdlog, ~rlnorm(N, fixed_meanlog, .x)),
    poverty_count = map_dbl(income_sample, ~sum(.x < linea_de_pobreza)),
    poverty_pct = poverty_count / N,
    gini = map_dbl(income_sample, calc_gini),
    actual_mean = map_dbl(income_sample, mean),
    median_income = map_dbl(income_sample, median),
    poverty_text = paste0(
      "<b>", percent(poverty_pct, accuracy = 0.1), "</b> en pobreza | ",
      "<b>Gini: ", round(gini, 3), "</b><br>",
      "Promedio: $", format(round(actual_mean), big.mark = "."),
      " | Mediana: $", format(round(median_income), big.mark = ".")
    )
  )

initial_sample_sd <- sd_steps_data$income_sample[[initial_sd_idx]]
initial_poverty_sample_sd <- initial_sample_sd[initial_sample_sd < linea_de_pobreza]
initial_non_poverty_sample_sd <- initial_sample_sd[initial_sample_sd >= linea_de_pobreza]

p_sd <- plot_ly(alpha = 0.8) %>%
  add_histogram(
    x = initial_poverty_sample_sd,
    name = "En pobreza",
    xbins = bins_config,
    marker = list(color = '#d62728')
  ) %>%
  add_histogram(
    x = initial_non_poverty_sample_sd,
    name = "Sobre línea de pobreza",
    xbins = bins_config,
    marker = list(color = '#2ca02c')
  )

sd_slider_steps <- purrr::map(1:nrow(sd_steps_data), function(i) {
  poverty_sample <- sd_steps_data$income_sample[[i]][sd_steps_data$income_sample[[i]] < linea_de_pobreza]
  non_poverty_sample <- sd_steps_data$income_sample[[i]][sd_steps_data$income_sample[[i]] >= linea_de_pobreza]
  list(
    method = 'update',
    args = list(
      list(x = list(poverty_sample, non_poverty_sample)),
      list(annotations = list(list(text = sd_steps_data$poverty_text[[i]])))
    ),
    label = sd_steps_data$label[i]
  )
})

p_sd <- p_sd %>% layout(
  title = "Efecto de la redistribución sobre la pobreza<br><sub>Distribución Log-normal - Promedio similar, varía dispersión (meanlog=10.05)</sub>",
  xaxis = list(range = c(0, 80000), title = "Ingreso mensual ($)", zeroline = FALSE),
  yaxis = list(title = "Cantidad de personas"),
  barmode = 'stack',
  annotations = list(
    list(
      x = 0.98, y = 0.95,
      xref = 'paper', yref = 'paper',
      text = sd_steps_data$poverty_text[[initial_sd_idx]],
      showarrow = FALSE,
      xanchor = 'right',
      font = list(size = 13),
      bgcolor = 'rgba(255,255,255,0.8)',
      borderpad = 8
    )
  ),
  shapes = list(
    list(
      type = 'line',
      x0 = linea_de_pobreza, x1 = linea_de_pobreza,
      y0 = 0, y1 = 1,
      yref = 'paper',
      line = list(color = 'red', width = 2, dash = 'dash')
    )
  ),
  sliders = list(
    list(
      active = initial_sd_idx - 1,
      currentvalue = list(prefix = "Dispersión (sdlog): "),
      steps = sd_slider_steps,
      pad = list(t = 40)
    )
  )
)

p_sd
```

## Notas metodológicas

- **Distribución Log-normal**: Distribución asimétrica con cola derecha pesada, ampliamente utilizada en economía para modelar ingresos. Es más realista que la distribución normal porque:
  - No permite valores negativos (como los ingresos reales)
  - Tiene asimetría positiva (la mayoría gana poco, pocos ganan mucho)
  - Los efectos multiplicativos de la economía generan distribuciones log-normales naturalmente

- **Parámetros de la log-normal**:
  - **meanlog**: Controla la ubicación de la distribución (mueve toda la distribución). En el Caso 1 varía este parámetro.
  - **sdlog**: Controla la dispersión/desigualdad. Mayor sdlog = mayor desigualdad. En el Caso 2 varía este parámetro.

- **Relación entre parámetros y estadísticos**:
  - Mediana = exp(meanlog)
  - Media = exp(meanlog + sdlog²/2)

- **Coeficiente de Gini**: Medida de desigualdad entre 0 (igualdad perfecta) y 1 (desigualdad máxima).
  - Argentina tiene un Gini real de aproximadamente 0.40-0.43
  - Para log-normal: Gini ≈ 2·Φ(sdlog/√2) - 1, donde Φ es la función de distribución normal estándar

- **Línea de pobreza**: Fijada en $15.000 para esta simulación (referencia ilustrativa).

- **Datos simulados**: N=10.000 personas. Los resultados son ilustrativos de los conceptos, no proyecciones reales.